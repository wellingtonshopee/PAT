{% extends "base.html" %}

{% block title %}Coleta de Inventário{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Coleta de Inventário</h2>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">
            Buscar Item por Código Patrimonial
        </div>
        <div class="card-body">
            <form method="GET" action="{% url 'patrimonio:coleta_inventario' %}">
                <div class="form-group mb-3">
                    <label for="codigo_patrimonial">Código Patrimonial / QR Code:</label>
                    <input type="text" class="form-control" id="codigo_patrimonial" name="codigo_patrimonial" placeholder="Digite o código ou escaneie o QR Code" value="{{ codigo_patrimonial_preenchido|default:'' }}">
                </div>
                <button type="submit" class="btn btn-primary">Buscar</button>
            </form>
        </div>
    </div>

    {% if item_encontrado %}
    <div class="card mt-4">
        <div class="card-header">
            Item Encontrado: {{ item_encontrado.nome }}
        </div>
        <div class="card-body">
            <p><strong>Código Patrimonial:</strong> {{ item_encontrado.codigo_patrimonial }}</p>
            <p><strong>Número de Série:</strong> {{ item_encontrado.numero_serie }}</p>
            <p><strong>Descrição:</strong> {{ item_encontrado.descricao }}</p>
            <p><strong>Localização Atual:</strong> {{ item_encontrado.localizacao.nome }}</p>
            <p><strong>Responsável Atual:</strong> {% if item_encontrado.responsavel_atual %}{{ item_encontrado.responsavel_atual.get_full_name }}{% else %}Não Atribuído{% endif %}</p>
            <p><strong>Última Atualização:</strong> {{ item_encontrado.data_ultima_atualizacao|date:"d/m/Y H:i:s" }}</p>

            <h5 class="mt-4">Registrar Presença / Atualizar Dados:</h5>
            <form method="POST" action="{% url 'patrimonio:confirmar_inventario' %}">
                {% csrf_token %}
                <input type="hidden" name="item_id" value="{{ item_encontrado.id }}">

                <div class="form-group mb-3">
                    <label for="nova_localizacao">Nova Localização (Opcional):</label>
                    <select class="form-control" id="nova_localizacao" name="nova_localizacao">
                        <option value="">Manter Localização Atual</option>
                        {% for loc in localizacoes %}
                            <option value="{{ loc.id }}" {% if loc == item_encontrado.localizacao %}selected{% endif %}>{{ loc.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                
                <div class="form-group mb-3">
                    <label for="novo_responsavel">Novo Responsável (Opcional):</label>
                    <select class="form-control" id="novo_responsavel" name="novo_responsavel">
                        <option value="">Manter Responsável Atual</option>
                        {% for user_obj in users_disponiveis %} {# Você precisaria passar 'users_disponiveis' para o contexto da view #}
                            <option value="{{ user_obj.id }}" {% if user_obj == item_encontrado.responsavel_atual %}selected{% endif %}>{{ user_obj.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
              

                <div class="form-group mb-3">
                    <label for="observacoes_inventario">Observações do Inventário (Opcional):</label>
                    <textarea class="form-control" id="observacoes_inventario" name="observacoes_inventario" rows="3" placeholder="Ex: Item em bom estado, verificado, etc."></textarea>
                </div>

                <button type="submit" class="btn btn-success">Confirmar Inventário</button>
                <a href="{% url 'patrimonio:coleta_inventario' %}" class="btn btn-secondary">Limpar / Novo Item</a>
            </form>
        </div>
    </div>
    {% else %}
    <p class="text-muted">Nenhum item encontrado ou buscado ainda. Utilize o campo acima para buscar um item.</p>
    {% endif %}

</div>
{% endblock %}